---
title: "DaniÃ«l's Data"
output: html_document
---

```{r, messages=FALSE}
library(tidyverse)
```

# Organize and clean data

```{r}
#Read excel files in folder
files <- list.files(path = "responses", pattern = "\\.csv$")

#read in all separate data files into a single list
#gives warning that can be ignored (last line not empty)
datalist <- lapply(
  paste0("responses/", files), 
  function(x) suppressWarnings(read.table(x, header = F))
)

#determine max length to fill dataframe
max_length <- max(unlist(lapply(datalist,length)))

#fill dataframe
df_filled <- lapply(datalist,function(x) {
  ans <- rep(NA,length=max_length);
  ans[1:length(x)]<- x;
  return(ans)
})

colnamelist <- c("ID", "length", "response", "effect_size_abs", "effect_size", "true_mean1", "true_mean2", "obs_mean_1", "obs_mean2", "obs_mean_dif", "df", "tvalue", "pvalue", "obs_power", "d")

#combine lists into a dataframe, make numeric and rename columns
dat <- do.call(rbind, df_filled) %>%
  as.data.frame() %>%
  mutate_all(as.numeric) %>%
  rename_at(1:15, ~ colnamelist) %>%
  # deal with extra values on end of each line
  gather(key, val, 16:ncol(.)) %>%
  filter(!is.na(val)) %>%
  select(-key) %>%
  group_by_at(vars(one_of(colnamelist))) %>%
  nest()
```



## Create variables

```{r}
#create variable for correct/incorrect
#create variable for sig/nonsig

all_data <- dat %>%
  mutate(
    significant = ifelse(pvalue <= 0.05, 1, 0),
    response = recode(response, "0" = 0, "1" = 1, "2" = -1),
    right_answer = case_when( 
      (effect_size == 0) ~ 0,
      (effect_size > 0) ~ 1,
      (effect_size < 0) ~ -1
    ),
    correct = ifelse(response == right_answer, 1, 0)
  )

#subset data, only trials with more than 5 responses
all_data_sub <- filter(all_data, length > 5)
```

```{r}
# calculate percents for each judgment as sig for each effect_size
# for use in plots below
sub_pcnt <- all_data_sub %>%
  group_by(right_answer, effect_size) %>%
  summarise(
    sig = mean(pvalue < .05) %>% round(2),
    z = mean(response == 0),
    p = mean(response == 1),
    n = mean(response == -1)
  ) %>%
  gather(response, pcnt, z:n) %>%
  mutate(
    response = recode(response, "z" = 0, "p" = 1, "n" = -1),
    pcnt = round(pcnt, 2),
    correct = right_answer == response
  )
```

## Plots

### Observed mean difference by effect size and response

```{r obs-mean-diff, fig.width = 8, fig.height = 5}
  ggplot() +
    geom_rect(data = sub_pcnt,
              aes(fill = correct),
              xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, 
              alpha = 0.3, show.legend = FALSE) +
    geom_vline(data = all_data_sub, aes(xintercept = effect_size), color = "red") +
    geom_histogram(data = all_data_sub, aes(x=obs_mean_dif), 
                   binwidth = 0.1, color = "black", fill = "white") + 
    geom_text(data = sub_pcnt, aes(label = pcnt), x = -1.5, y = 25) +
    facet_grid(response~effect_size, labeller = label_both) +
    theme_bw() +
    scale_fill_manual(values = c("white", "grey50"))

ggsave("obs_mean_diff.png", width = 16, height = 10)

```

### P-values by effect size and response

```{r fig-p, fig.width = 8, fig.height = 5}
ggplot() +
  geom_rect(data = sub_pcnt, aes(fill = correct),
              xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, 
              alpha = 0.3, show.legend = FALSE) +
  geom_histogram(data = all_data_sub, aes(x=pvalue),
                 binwidth = 0.05, boundary = 0, 
                 color = "black", fill = "white", alpha = 0.5) + 
  geom_text(data = sub_pcnt, aes(label = sig), x = .2, y = 50) +
  facet_grid(response ~ effect_size, labeller = label_both) +
  theme_bw() +
  scale_fill_manual(values = c("white", "grey50"))

ggsave("power.png", width = 16, height = 10)
```

## Actual and observed d and power by effect size and response

(I filtered out rows with <= 5 observations)

```{r}
all_data_sub %>%
  group_by(effect_size, response, correct) %>%
  summarize(
    n = n(),
    mean_d = mean(-d, na.rm = T), #note -d because d in dataset is calculated in opposite diferection!
    power = mean(pvalue <= 0.05), 
    mean_obs_d = mean(obs_mean_dif, na.rm = T), 
    obs_power = mean(obs_power, na.rm = T)
  ) %>%
  mutate_if(is.double, round, 3) %>%
  filter(n > 5) %>%
  knitr::kable()

```

## Actual and observed d and power by effect size

(ignoring response)

```{r}
all_data_sub %>%
  group_by(effect_size) %>%
  summarize(
    n = n(),
    correct_pcnt = mean(correct),
    mean_d = mean(-d, na.rm = T), #note -d because d in dataset is calculated in opposite diferection!
    power = mean(pvalue <= 0.05), 
    mean_obs_d = mean(obs_mean_dif, na.rm = T), 
    obs_power = mean(obs_power, na.rm = T)
  ) %>%
  mutate_if(is.double, round, 3) %>%
  knitr::kable()

```

# Calculate X% of data

(I'm not sure what's going on here)

```{r}

find_cover_region <- function(x, alpha=0.5) {
  n <- length(x)
  x <- sort(x)
  k <- as.integer(round((1-alpha) * n))
  i <- which.min(x[seq.int(n-k, n)] - x[seq_len(k+1L)])
  c(x[i], x[n-k+i-1L])
}
tapply(-all_data_sub$d, all_data_sub$response, find_cover_region)
tapply(all_data_sub$obs_mean_dif, all_data_sub$response, find_cover_region)
```